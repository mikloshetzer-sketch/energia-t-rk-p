<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EU energiaimport – interaktív térkép</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111; }
    #map { height: 72vh; width: 100%; }

    .bar{
      padding:10px 12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      border-bottom:1px solid #e6e6e6; background:#fff; position:sticky; top:0; z-index:999;
    }
    select{ padding:6px 10px; }
    .note{ font-size:12px; opacity:.75; }

    .legend{
      background:#fff; padding:10px 12px; border-radius:10px; line-height:1.2;
      box-shadow:0 4px 18px rgba(0,0,0,.12);
    }
    .legend .row{ display:flex; justify-content:space-between; gap:12px; }

    .panel{ border-top:1px solid #e6e6e6; padding:12px; background:#fff; }
    .panel h3{ margin:0 0 8px 0; font-size:14px; }
    .panel .sub{ font-size:12px; opacity:.75; margin-bottom:10px; }

    table{ border-collapse:collapse; width:100%; max-width:820px; }
    th, td{ text-align:left; padding:8px 10px; border-bottom:1px solid #eee; font-size:13px; vertical-align:top; }
    th{ font-size:12px; opacity:.8; text-transform:uppercase; letter-spacing:.02em; }
    .tag{ display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#f2f4f7; margin-left:8px; }
    .muted{ opacity:.75; }
    tr.clickable{ cursor:pointer; }
    tr.clickable:hover{ background:#f7f9fc; }
  </style>
</head>
<body>

  <div class="bar">
    <label>
      Mutató:
      <select id="metric">
        <option value="quantity_mt">Mennyiség (Mt)</option>
        <option value="value_eur_bn">Érték (€ mrd)</option>
      </select>
    </label>

    <label>
      Energiatípus:
      <select id="energyType">
        <option value="ALL">Összes</option>
      </select>
    </label>

    <span class="note">Forrás: Eurostat / Comext – Q3 2025</span>
  </div>

  <div id="map"></div>

  <div class="panel">
    <h3 id="topTitle">TOP 5 beszállító</h3>
    <div class="sub" id="topSub">—</div>
    <div id="top5"></div>
    <div class="sub muted" style="margin-top:8px;">
      Tipp: kattints a TOP 5 listában egy országra → a térkép odaugrik és felnyitja az adatokat.
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map').setView([54, 15], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

    let countriesGeoJSON = null;
    let energyRows = [];
    let layer = null;

    // ISO2 -> Leaflet layer (hogy a TOP listából rá tudjunk zoomolni)
    const isoLayerMap = new Map();

    // TOP marker fallback (ha nincs polygon)
    const topFallbackMarkers = new Map();

    const metricSel = document.getElementById('metric');
    const typeSel   = document.getElementById('energyType');
    const topTitle = document.getElementById('topTitle');
    const topSub   = document.getElementById('topSub');
    const topBox   = document.getElementById('top5');

    // GeoJSON ISO2 hiány esetére (név -> ISO2)
    const ISO_FALLBACK = {
      "UNITED STATES OF AMERICA":"US",
      "UNITED STATES":"US",
      "RUSSIA":"RU",
      "UNITED KINGDOM":"GB",
      "GREAT BRITAIN":"GB",
      "NORWAY":"NO",
      "QATAR":"QA",
      "ALGERIA":"DZ",
      "SAUDI ARABIA":"SA",
      "CHINA":"CN",
      "SOUTH KOREA":"KR",
      "IRAN":"IR",
      "VIETNAM":"VN",
      "VENEZUELA":"VE",
      "BOLIVIA":"BO",
      "TANZANIA":"TZ",
      "SYRIA":"SY",
      "CZECHIA":"CZ"
    };

    // Ha polygon nincs: ide tesszük a TOP országok hozzávetőleges koordinátáját
    // (csak akkor használjuk, ha tényleg nem találunk polygon layer-t)
    const CENTROID_FALLBACK = {
      "SA":[23.8859, 45.0792], // Saudi Arabia
      "CN":[35.8617, 104.1954], // China
      "QA":[25.3548, 51.1839],
      "DZ":[28.0339, 1.6596],
      "NO":[60.4720, 8.4689],
      "US":[39.8283, -98.5795],
      "RU":[61.5240, 105.3188],
      "AE":[23.4241, 53.8478] // UAE, ha előfordulna
    };

    function num(x){
      const v = Number(String(x ?? '').replace(',', '.'));
      return Number.isFinite(v) ? v : null;
    }

    function buildIndex(rows){
      const idx = new Map();
      for (const r of rows){
        const iso2 = String(r.iso2 || '').trim().toUpperCase();
        const t = String(r.energy_type || '').trim();
        if (!iso2 || !t) continue;
        idx.set(iso2 + '|' + t, {
          iso2,
          country: String(r.country || iso2).trim(),
          energy_type: t,
          quantity_mt: num(r.quantity_mt),
          value_eur_bn: num(r.value_eur_bn)
        });
      }
      return idx;
    }

    function buildCountryNameMap(rows){
      const m = new Map();
      for (const r of rows){
        const iso2 = String(r.iso2 || '').trim().toUpperCase();
        const c = String(r.country || '').trim();
        if (iso2 && c && !m.has(iso2)) m.set(iso2, c);
      }
      return m;
    }

    function metricLabel(metric){ return metric === 'value_eur_bn' ? 'Érték (€ mrd)' : 'Mennyiség (Mt)'; }

    function formatMetric(v, metric){
      if (v == null) return '–';
      return metric === 'value_eur_bn' ? ('€' + v.toFixed(2) + ' mrd') : (v.toFixed(2) + ' Mt');
    }

    function getScale(values){
      const vs = values.filter(v => v != null).sort((a,b)=>a-b);
      if (vs.length === 0) return {min:0, max:1};
      const min = vs[0], max0 = vs[vs.length-1];
      return {min, max: (max0 === min ? min + 1 : max0)};
    }

    function shade(val, min, max){
      if (val == null) return 0.08;
      const t = Math.max(0, Math.min(1, (val - min) / (max - min)));
      return 0.25 + 0.65 * t;
    }

    function noDataExplanation(chosenType){
      const t = chosenType === 'ALL' ? 'az adott energiatípus(ok)ban' : `(${chosenType})`;
      return `EU-import: nincs regisztrált szállítás ${t} a vizsgált időszakban (Q3 2025).`;
    }

    function computeForCountry(iso2, idx, metric, chosenType){
      if (!iso2) return { value:null, breakdown:[] };

      if (chosenType !== 'ALL'){
        const it = idx.get(iso2 + '|' + chosenType);
        return { value: it ? it[metric] : null, breakdown: it ? [it] : [] };
      }

      const items = [];
      for (const v of idx.values()) if (v.iso2 === iso2) items.push(v);
      if (items.length === 0) return { value:null, breakdown:[] };

      let sum = 0, any = false;
      for (const it of items){
        if (it[metric] != null){ sum += it[metric]; any = true; }
      }
      items.sort((a,b)=> (b[metric] ?? -Infinity) - (a[metric] ?? -Infinity));
      return { value: any ? sum : null, breakdown: items };
    }

    // TOP 5 számítás: visszaadja a listát + set-et a kiemeléshez
    function getTop5(idx){
      const metric = metricSel.value;
      const chosenType = typeSel.value;

      const isoSet = new Set();
      for (const v of idx.values()) isoSet.add(v.iso2);

      const totals = [];
      for (const iso2 of isoSet){
        const { value } = computeForCountry(iso2, idx, metric, chosenType);
        if (value != null && value > 0) totals.push([iso2, value]);
      }

      totals.sort((a,b)=> b[1] - a[1]);
      const top = totals.slice(0, 5);

      const topSet = new Set(top.map(x => x[0]));
      return { top, topSet };
    }

    function renderTop5(top, nameMap){
      const metric = metricSel.value;
      const chosenType = typeSel.value;
      const typeText = chosenType === 'ALL' ? 'Összes energiatípus' : chosenType;

      topTitle.textContent = 'TOP 5 beszállító';
      topSub.textContent = `${typeText} • ${metricLabel(metric)} • Q3 2025`;

      if (top.length === 0){
        topBox.innerHTML = `<div class="muted">Nincs megjeleníthető TOP lista a jelenlegi szűrőkkel.</div>`;
        return;
      }

      const rowsHtml = top.map(([iso2, v], i) => {
        const name = nameMap.get(iso2) || iso2;
        return `
          <tr class="clickable" data-iso2="${iso2}" data-rank="${i+1}">
            <td><b>${i+1}.</b></td>
            <td><b>${name}</b> <span class="tag">${iso2}</span></td>
            <td><b>${formatMetric(v, metric)}</b></td>
          </tr>
        `;
      }).join('');

      topBox.innerHTML = `
        <table>
          <thead>
            <tr><th>#</th><th>Ország</th><th>${metricLabel(metric)}</th></tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;

      // kattintás: zoom + popup
      topBox.querySelectorAll('tr.clickable').forEach(tr => {
        tr.addEventListener('click', () => {
          const iso2 = tr.getAttribute('data-iso2');
          focusCountry(iso2);
        });
      });
    }

    function clearTopFallbackMarkers(){
      for (const m of topFallbackMarkers.values()) m.remove();
      topFallbackMarkers.clear();
    }

    function focusCountry(iso2){
      // 1) ha van polygon layer: odazoomol + popup
      const lyr = isoLayerMap.get(iso2);
      if (lyr){
        try {
          map.fitBounds(lyr.getBounds(), { padding:[30,30] });
          lyr.openPopup();
          return;
        } catch(e) {}
      }

      // 2) ha nincs polygon: fallback marker koordinátával
      const latlng = CENTROID_FALLBACK[iso2];
      if (latlng){
        map.setView(latlng, 4);
        const m = topFallbackMarkers.get(iso2);
        if (m) m.openPopup();
        return;
      }

      alert('Ehhez az országhoz nem találok térképi objektumot (GeoJSON), és nincs fallback koordináta sem.');
    }

    function render(){
      const metric = metricSel.value;
      const chosenType = typeSel.value;

      const idx = buildIndex(energyRows);
      const nameMap = buildCountryNameMap(energyRows);

      // TOP 5 előre (kiemeléshez is kell)
      const { top, topSet } = getTop5(idx);

      // skála
      const vals = [];
      const isoSetAll = new Set();
      for (const v of idx.values()) isoSetAll.add(v.iso2);
      for (const iso2 of isoSetAll){
        const { value } = computeForCountry(iso2, idx, metric, chosenType);
        if (value != null) vals.push(value);
      }
      const {min, max} = getScale(vals);

      // régi rétegek törlése
      isoLayerMap.clear();
      clearTopFallbackMarkers();
      if (layer) layer.remove();

      layer = L.geoJSON(countriesGeoJSON, {
        style: (feature) => {
          const p = feature.properties || {};
          const name = p.ADMIN || p.name || '';
          let iso2 = String(p.ISO_A2 || '').trim().toUpperCase();

          if (!iso2 || iso2 === '-99'){
            const key = String(name).toUpperCase();
            iso2 = ISO_FALLBACK[key] || '';
          }

          const { value } = computeForCountry(iso2, idx, metric, chosenType);

          const isTop = topSet.has(iso2);

          return {
            color: isTop ? '#000' : '#333',
            weight: isTop ? 2.5 : 1,
            fillColor: '#0057b8',
            fillOpacity: shade(value, min, max)
          };
        },

        onEachFeature: (feature, lyr) => {
          const p = feature.properties || {};
          const featureName = p.ADMIN || p.name || 'Ország';

          let iso2 = String(p.ISO_A2 || '').trim().toUpperCase();
          if (!iso2 || iso2 === '-99'){
            const key = String(featureName).toUpperCase();
            iso2 = ISO_FALLBACK[key] || '';
          }

          // eltároljuk a layer-t, hogy a TOP listából rá tudjunk ugrani
          if (iso2 && !isoLayerMap.has(iso2)) isoLayerMap.set(iso2, lyr);

          const displayName = (iso2 && nameMap.get(iso2)) ? nameMap.get(iso2) : featureName;

          function tooltipHtml(detailed=false){
            const metric = metricSel.value;
            const chosenType = typeSel.value;
            const { value, breakdown } = computeForCountry(iso2, idx, metric, chosenType);

            const header = `<b>${displayName}</b> <span class="tag">${iso2 || '—'}</span>`;

            if (!iso2){
              return `${header}<br><span class="muted">Nincs országkód, ezért nem párosítható az adattal.</span>`;
            }

            if (value == null || value === 0){
              return `${header}<br><span class="muted">${noDataExplanation(chosenType)}</span>`;
            }

            if (chosenType !== 'ALL'){
              return `${header}<br><b>${chosenType}</b>: ${formatMetric(value, metric)}`;
            }

            if (!detailed){
              const top2 = breakdown.slice(0,2)
                .map(it => `${it.energy_type}: ${formatMetric(it[metric], metric)}`)
                .join('<br>');
              return `${header}<br><b>Összes</b>: ${formatMetric(value, metric)}<br>${top2}`;
            } else {
              const lines = breakdown
                .map(it => `${it.energy_type}: <b>${formatMetric(it[metric], metric)}</b>`)
                .join('<br>');
              return `${header}<br><b>Összes</b>: ${formatMetric(value, metric)}<br><br>${lines}`;
            }
          }

          lyr.bindTooltip(() => tooltipHtml(false), { sticky:true, direction:'auto', opacity:0.95 });

          lyr.on('mouseover', () => lyr.setStyle({ weight: topSet.has(iso2) ? 3 : 2 }));
          lyr.on('mouseout',  () => lyr.setStyle({ weight: topSet.has(iso2) ? 2.5 : 1 }));

          lyr.on('click', () => {
            lyr.bindPopup(tooltipHtml(true)).openPopup();
          });
        }
      }).addTo(map);

      // Legend
      if (window._legend) window._legend.remove();
      const legend = L.control({position:'bottomright'});
      legend.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <div><b>Színezés</b></div>
          <div class="row"><span>min</span><span>${formatMetric(min, metric)}</span></div>
          <div class="row"><span>max</span><span>${formatMetric(max, metric)}</span></div>
        `;
        return div;
      };
      legend.addTo(map);
      window._legend = legend;

      // TOP 5 panel
      renderTop5(top, nameMap);

      // TOP 5 fallback markerek azoknak, akiknél nincs polygon layer
      for (const [iso2, v] of top){
        if (isoLayerMap.has(iso2)) continue;

        const latlng = CENTROID_FALLBACK[iso2];
        if (!latlng) continue;

        const m = L.circleMarker(latlng, { radius: 7, color:'#000', weight:2, fillColor:'#0057b8', fillOpacity:0.9 })
          .addTo(map)
          .bindPopup(`<b>${nameMap.get(iso2) || iso2}</b> <span class="tag">${iso2}</span><br>TOP 5 beszállító<br><b>${formatMetric(v, metricSel.value)}</b>`);
        topFallbackMarkers.set(iso2, m);
      }
    }

    async function loadAll(){
      const countriesUrl = 'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson';
      const cRes = await fetch(countriesUrl);
      countriesGeoJSON = await cRes.json();

      await new Promise((resolve, reject) => {
        Papa.parse('./energy_data.csv', {
          download:true, header:true, skipEmptyLines:true,
          complete:(results)=>{ energyRows = results.data || []; resolve(); },
          error: reject
        });
      });

      const types = Array.from(new Set(
        energyRows.map(r => String(r.energy_type || '').trim()).filter(Boolean)
      )).sort();

      for (const t of types){
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        typeSel.appendChild(opt);
      }

      render();
    }

    metricSel.addEventListener('change', render);
    typeSel.addEventListener('change', render);

    loadAll().catch(err => {
      console.error(err);
      alert('Hiba betöltés közben. Ellenőrizd, hogy az energy_data.csv a repó gyökerében van-e.');
    });
  </script>
</body>
</html>
